# EPD Calendar 项目重构计划

## 目标

将项目重构为"消息总线架构 + 平台抽象层"的清晰架构，解决main.rs混乱问题。

## 重构步骤

### 第一阶段：创建平台抽象层

1. **创建** **`src/platform/mod.rs`** - 平台模块入口
2. **创建** **`src/platform/common.rs`** - 定义平台trait和类型

   * `Platform` trait：定义平台初始化和驱动创建接口

   * `PlatformError`：平台相关错误类型
3. **创建** **`src/platform/esp32.rs`** - ESP32平台实现

   * 实现 `Platform` trait，封装ESP32硬件初始化

   * 创建各驱动的工厂方法
4. **创建**`src/playform/tspi.rs` - 原嵌入式Linux平台实现（实际上我使用的是泰山派，所以命名为tspi）

   * 实现 `Platform` trait，封装原嵌入式Linux平台的硬件初始化
   * 创建各驱动的工厂方法
5. **创建** **`src/platform/simulator.rs`** - 模拟器平台实现

   * 实现 `Platform` trait，封装模拟器初始化

### 第二阶段：实现消息总线

1. **创建** **`src/system/message_bus.rs`** - 消息总线核心

   * `SystemMessage` 枚举：定义系统消息类型

   * `MessageBus` 结构体：消息分发和订阅机制

   * 支持异步消息发送和接收
2. **创建** **`src/system/mod.rs`** - 系统模块入口

### 第三阶段：创建系统管理器

1. **创建** **`src/system/manager.rs`** - 系统管理器

   * `SystemManager` 结构体：管理所有组件生命周期

   * 封装平台、消息总线、数据源注册表

   * 提供统一的组件启动和运行接口

   * 处理消息分发和组件协调

### 第四阶段：重构数据源和任务

1. **重构数据源** - 适配消息总线

   * 修改数据源通过消息总线发送更新事件

   * 移除对全局 `DISPLAY_EVENTS` 的直接依赖
2. **重构显示任务** - 适配消息总线

   * 订阅显示刷新消息

   * 通过消息总线接收数据更新通知

### 第五阶段：重构main.rs

1. **简化main.rs** - 清晰的启动流程

   * 初始化平台

   * 创建消息总线

   * 创建系统管理器

   * 运行主循环
2. **移除全局静态变量** - 通过系统管理器管理

   * 移除 `DISPLAY_DRIVER`, `NETWORK_DRIVER` 等全局变量

   * 所有驱动由系统管理器统一管理

### 第六阶段：清理和优化

1. **移除旧的** **`DefaultSystemApi`** - 功能分散到各组件
2. **更新导入路径** - 适配新的模块结构
3. **验证编译** - 确保所有平台编译通过

## 架构优势

* **清晰的分层**：平台抽象层、系统层、应用层分离

* **松耦合**：组件间通过消息总线通信，不直接依赖

* **可扩展**：新增平台或组件只需实现对应trait

* **可测试**：各模块职责单一，易于单元测试

