# 功耗管理

## 1. 功耗模式

### 深度睡眠
- 主CPU完全关闭，RTC继续运行
- ESP32-C6约10μA
- 核心目标，主CPU大部分时间处于此状态

### 轻度活跃
- 主CPU短暂运行（显示刷新10秒，网络同步5-10秒）
- 任务完成后立即切换至深度睡眠

### 高度活跃
- BLE连接状态，约几十mA
- 正常电量启用，低电量禁用
- 超时后强制切换至深度睡眠

## 2. 电量状态（两种简化模式）

### 正常电量（≥30%）
- 全功能运行
- 每2小时同步网络
- 每分钟刷新显示
- 开启整点报时和蓝牙功能

### 低电量（<30%）
- 功能裁剪，最大化主CPU休眠时长：
  - 关闭蓝牙服务（禁止配网和OTA）
  - 关闭整点报时
  - 网络同步间隔延长至4小时，仅重试1次
  - 显示仅刷新核心时间信息，关闭天气和格言区域
  - 禁用日志输出（切换至无log模式）
  - 仅保留闹钟核心功能，触发后正常响应

## 3. 功耗优化核心措施

1. **唤醒源收敛**：主CPU仅由RTC定时器、按键触发唤醒，关闭所有冗余唤醒源
2. **任务批处理**：将网络同步、显示刷新等任务集中在同一唤醒周期内执行
3. **外设按需启停**：主CPU唤醒后仅开启当前任务所需外设
4. **休眠时长最大化**：精准计算下次唤醒时间点
5. **冗余功能裁剪**：低电量模式下进一步裁剪非核心功能
6. **基于`embassy-rs`优化**：利用异步驱动和低功耗调度

## 4. 电量校准机制

- 首次上电及每充电一次，进行电池电压校准
- 修正ADC检测误差，确保电量状态判断准确
- 校准数据存储至FLASH固定分区，断电不丢失
