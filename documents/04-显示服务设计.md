# 显示服务详细设计

## 1. 显示特性

- **墨水屏型号**：yrd0750ryf665f60（7.5英寸，800×480，黑白红黄4色，仅使用黑白2色）
- **刷新特性**：支持局部写数据，但刷新必须是全局刷新
- **刷新时间**：全局刷新（包括清屏）后，BUSY信号约10秒才结束
- **低功耗优化**：低电量模式下，仅在时间变更、闹钟触发时刷新，关闭每分钟自动刷新

## 2. 显示内容布局（800×480像素）

```
┌─────────────────────────────────────────────────────────────────┐
│ 时间区域（顶部20%）                                            │
│ 23:59               周一                                   80%  │
│ 2024-01-15 [元旦]                                           ●   │
│ 甲辰年冬月初四 龙 [宜：出行 忌：嫁娶]                          │
├─────────────────────────────────────────────────────────────────┤
│ 天气区域（中部30%）                                            │
│ 🌤 22°C 65%      🌤 25°/18° 🌧 24°/19° ☀ 23°/17°             │
│ 室内：23°C 55%   今天        明天        后天                    │
├─────────────────────────────────────────────────────────────────┤
│ 格言区域（底部50%）                                            │
│ 格言：知足常乐，终身不辱；知止常止，终身不耻。                  │
│                                                              ▼  │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 显示刷新状态机

```rust
enum RefreshState {
    Idle,           // 空闲状态，可接收新刷新请求
    SendingData,    // 工作状态，发送像素数据到屏幕（约500ms）
    Refreshing,     // 已发送刷新命令，等待BUSY信号（最多等待10秒）
    Error,          // 刷新错误（如BUSY超时，初始化失败等）
}
```

## 4. 刷新流程优化

### 数据准备阶段
- 更新显示缓冲区的局部区域（时间、天气、格言等）
- 不立即刷新，等待统一调度，避免频繁唤醒主CPU

### 刷新调度策略
- 正常模式：每分钟在0秒开始刷新，优先级应当比其他事件优先级低
- 刷新期间不接受新的刷新请求（丢弃或排队，优先保障核心任务）

### BUSY等待优化
- 发送刷新命令后进入Refreshing状态
- 使用异步功能检查BUSY信号，超时10秒后切换到Error状态
