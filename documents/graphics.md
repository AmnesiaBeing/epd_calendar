# 布局系统代码生成提示词
请基于以下完整约束和要求，生成一套高性能布局系统的核心代码，需严格遵循**构建时承担所有复杂逻辑、运行时极简执行**的核心目标，代码结构清晰、注释完备，便于工程化落地和后续扩展。

## 一、核心目标约束
1.  **预计算优先**：所有布局计算、点阵图转换、指令生成工作必须在构建时完成，运行时不执行任何复杂运算。
2.  **运行时极简**：运行时仅负责**动态变量替换**和**绘制指令批量执行**，无布局解析、图形转换、复杂逻辑判断。
3.  **性能导向**：面向低算力设备优化，优先保证运行时执行效率，减少内存占用和CPU开销。

## 二、设计原则
1.  **静态与动态分离**：明确区分构建时可确定的静态内容和运行时变化的动态内容，动态内容需标记并绑定变量。
2.  **黑白色系**：背景固定为白色，所有内容（文字、SVG、分割线）固定为黑色，不支持任何其他颜色配置。
3.  **固定尺寸声明**：所有UI元素必须在XML中明确指定`width`和`height`，无自适应、流式布局逻辑。
4.  **布局扁平化**：Flex容器仅用于构建时布局计算，最终生成的绘制指令中无任何容器结构残留。

## 三、节点类型与属性规范
### （一）通用属性
-  根节点`<layout>`：必填`width`、`height`，无需`id`。
-  所有子元素（Text、SVG、Divider、Flex）：必填`id`、`width`、`height`。
-  动态元素：需添加`dynamic="true"`属性，变量名与元素`id`关联，在`<metadata>`中声明。

### （二）`<metadata>`标签规范（位于`<layout>`内开头）
1.  字体声明：仅支持1种字体，格式`<font path="字体文件路径" />`。
2.  字体大小声明：支持多种，格式`<font-sizes>16,18,24</font-sizes>`。
3.  动态变量声明：格式`<dynamic-variables><variable name="元素id" type="text/svg" /></dynamic-variables>`。
4.  动态SVG可选列表声明：格式`<dynamic-svg-list>icon1.svg,icon2.svg</dynamic-svg-list>`。

### （三）具体节点类型
1.  **文字（Text）**
    -  必填属性：`font-size`（必须在`<font-sizes>`中声明）。
    -  字符范围：仅限ASCII码十进制32~126的可见字符，超出字符替换为“?”并抛出警告。
    -  静态文字：构建时直接转换为点阵图；动态文字：构建时生成ASCII点阵库，运行时通过字符索引调用。
2.  **图像（SVG）**
    -  仅支持黑色+透明格式的基础SVG（矩形、圆形、直线、简单路径），禁止滤镜、渐变、复杂剪裁。
    -  必填属性：`src`（静态SVG为文件路径，动态SVG为默认文件路径）。
    -  所有SVG在构建时转换为与声明尺寸一致的点阵图，动态SVG需预生成所有可选文件的点阵图，形成资源池。
3.  **分割线（Divider）**
    -  支持水平（默认）、垂直方向，线宽对应元素的`height`（水平）或`width`（垂直）。
    -  绘制指令映射为`FILL_RECT_BLACK`。
4.  **弹性容器（Flex）**
    -  支持`direction`（row/column）、`justify`（start/end/center/space-between）、`padding`（1-4个值）属性。
    -  嵌套深度上限为**5层**，超出则抛出异常并终止构建。
    -  无实际布局价值的Flex容器（仅嵌套单个子元素、无padding、默认对齐）需自动扁平化合并。
    -  预计算完成后，需剥离所有Flex容器结构，仅保留叶子节点的绝对位置和点阵图信息。

## 四、构建时核心组件与功能要求
构建时包含5个核心组件，需按顺序执行，输出**结构化绘制指令集**和**点阵图资源池**。
1.  **布局解析器（LayoutParser）**
    -  解析XML文件，验证所有必填属性，生成初始节点树。
    -  校验Flex容器嵌套深度，超过5层抛出明确异常（含超标节点id和层级路径）。
    -  自动合并冗余Flex容器，减少无效嵌套层级。
    -  解析`<metadata>`标签，提取字体、字体大小、动态变量等配置信息。
2.  **预计算器（LayoutPrecomputer）**
    -  计算所有元素的绝对坐标（基于Flex容器属性、padding、子元素尺寸）。
    -  完成Flex容器扁平化剥离，生成仅包含叶子节点的最终布局树。
    -  输出布局树校验报告，包含元素id、绝对坐标、宽高、动态标记等信息。
3.  **点阵图转换器（BitmapConverter）**
    -  文字转点阵：基于声明字体和大小，将静态文字转换为1位/像素的黑白点阵图；生成ASCII可见字符的完整点阵库（动态文字用）。
    -  SVG转点阵：将SVG文件按声明尺寸像素级映射，转换为1位/像素的黑白点阵图，丢弃所有SVG原文件信息。
    -  点阵图格式：1位/像素（黑=1，白=0），携带元数据（宽高、对齐基准点）。
    -  重复点阵去重：通过哈希校验，对相同点阵数据仅保留一份副本，用索引映射复用。
4.  **点阵图验证器（BitmapValidator）**
    -  有效性验证：比对点阵图宽高与XML声明的元素宽高，不一致则抛出异常。
    -  合规性验证：校验点阵图是否为纯黑白、文字点阵是否在ASCII可见范围、点阵数据长度是否匹配宽高。
    -  冗余过滤：识别并剔除全白点阵（无显示价值），避免生成无效绘制指令。
    -  验证不通过则终止构建，输出精准错误信息（元素id、问题类型）。
5.  **绘制编译器（DrawCommandCompiler）**
    -  生成4类绘制指令，指令格式统一为`[指令类型标识, 元素id, 绝对坐标(x,y), 关联数据]`，指令类型分工明确：
        1.  `FILL_RECT_WHITE`：绘制白色背景，仅需1条覆盖整个`<layout>`尺寸的指令。
        2.  `FILL_RECT_BLACK`：绘制分割线，关联数据为宽高。
        3.  `DRAW_TEXT`：绘制文字点阵，关联数据为点阵图索引/ASCII字符索引、字体大小关联信息。
        4.  `DRAW_BITMAP`：绘制SVG点阵，关联数据为点阵图索引。
    -  动态指令处理：动态元素的指令中，可变部分用`{{变量名}}`作为占位符，与`<metadata>`中的变量绑定。
    -  指令集优化：合并相邻同类型指令，按“背景→分割线→文字→SVG”的层级排序，形成有序的全屏指令集。
    -  输出内容：结构化指令集文件（如JSON格式）、点阵图资源池文件、变量-索引映射表。
    -  支持构建结果缓存：无资源变更时，直接复用缓存的指令集和点阵图资源池，提升增量构建效率。

## 五、运行时核心组件与功能要求
运行时包含2个核心组件，逻辑极简，无任何冗余功能。
1.  **变量管理器（VariableManager）**
    -  核心功能：仅维护“变量名→点阵图索引/ASCII字符索引”的映射关系。
    -  支持批量更新变量，合并短时间内的多次更新请求，仅触发一次指令执行。
    -  舍弃公式求值、历史记录等复杂功能，仅保留变量存储、更新、占位符替换能力。
2.  **渲染器（Renderer）**
    -  加载构建时输出的结构化指令集和点阵图资源池，缓存至内存，无需解码步骤。
    -  执行流程：接收变量更新→替换指令集中的`{{变量名}}`占位符→按顺序批量执行所有指令→调用底层绘图API完成全屏绘制。
    -  无局部刷新逻辑，每次变量更新均触发全屏指令集执行。
    -  内存优化：仅缓存指令集和点阵图资源池，无其他缓冲区数据。

## 六、输出代码要求
1.  语言选择：优先选择Python/JavaScript/Go等通用语言，保证逻辑完整性。
2.  代码结构：按构建时、运行时组件划分模块，每个组件独立成类/函数，低耦合高内聚。
3.  关键注释：在核心逻辑（如Flex扁平化、点阵转换、指令生成、变量替换）处添加详细注释，说明设计思路和优化点。
4.  测试示例：提供完整的测试流程，包含：
    -  符合规范的XML布局示例文件；
    -  构建时执行脚本（解析→预计算→转换→验证→编译）；
    -  运行时执行脚本（变量更新→指令替换→全屏渲染）；
    -  输出测试结果（指令集文件内容、渲染效果模拟）。
5.  工程化适配：代码便于后续扩展，如预留`DRAW_TEXT`指令的“字形点阵+字元信息”优化接口。