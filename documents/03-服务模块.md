# 服务模块划分

## 1. 状态管理器 (StateManager)

**职责**：维护系统状态机，处理事件分发和状态转换，保障主CPU深度休眠优先级

**关键行为**：
- 监听所有系统事件，按优先级分发
- 根据当前状态和事件决定状态转换，优先导向深度睡眠
- 管理深度睡眠的进入和唤醒恢复，任务处理完成后立即触发休眠
- 计算下一次唤醒时间点（为RTC定时器提供调度计划，最大化休眠时长）
- 协调各服务模块的启动和停止，避免冗余运行
- 低电量状态切换与功能裁剪（正常/低电量）

## 2. 时间服务 (TimeService)

**职责**：时间管理、日历计算、事件调度，为系统提供唤醒计划

**关键行为**：
- 维护准确时间（RTC寄存器+软件校准偏移）
- 计算农历、节气、节假日（每日计算一次并缓存至固定分区）
- 处理时区转换，支持配置更新后的时区重校准
- 应对时间跳变（网络同步/手动修改），重新计算关联事件

## 3. 网络服务 (NetworkService)

**职责**：统一管理所有网络通信，按需连接以降低功耗

**关键行为**：
- Wi-Fi连接管理（按需连接，完成同步后立即断开，低电量延长连接间隔）
- SNTP时间同步（获取网络时间，校准本地RTC）
- 和风天气API调用（获取3天天气，缓存至固定分区）
- API调用限制管理（月≤20,000次）
- 网络错误重试（首次失败后2分30秒重试一次，低电量仅重试1次）
- 不承担OTA功能，OTA由蓝牙服务统一处理

## 4. 显示服务 (DisplayService)

**职责**：墨水屏驱动和UI渲染，优化刷新流程以减少主CPU占用时间

**关键行为**：
- ESP32-C6平台通过SPI接口驱动墨水屏
- 墨水屏非阻塞刷新状态机，避免主CPU空闲等待
- 整合时间、天气、传感器数据等信息显示
- 多状态界面显示（正常界面、二维码界面、错误提示、低电量提示）
- 处理长达10秒的刷新等待时间，期间主CPU进入轻睡眠
- 低电量模式下，将刷新频率优化为必要时刷新

## 5. 蓝牙服务 (BLE)

**职责**：BLE配网、配置管理、蓝牙OTA升级

**关键行为**：
- BLE广播和设备发现，正常电量下按需开启，低电量下禁用
- 与手机App的加密通信协议
- 配置接收和验证（Wi-Fi、闹钟、时区等）
- 配置保存到FLASH固定分区，标记脏数据并定期持久化
- 蓝牙OTA升级（接收固件、校验完整性、写入备用分区、触发重启切换）

## 6. 音频服务 (AudioService)

**职责**：蜂鸣器控制，低电量下禁用非必要音频输出

**关键行为**：
- ESP32-C6平台上使用LEDC外设产生PWM驱动蜂鸣器
- 整点报时（4短1长，正常电量启用，低电量禁用）
- 闹钟音乐播放（预设铃声：小星星、兰花草）
- 声音优先级管理（闹钟优先于整点报时）
- 音频输出完成后立即关闭PWM外设，释放资源

## 7. 配置管理器 (ConfigManager)

**职责**：配置持久化存储，管理FLASH固定分区

**关键行为**：
- 从FLASH固定分区加载配置到内存
- 配置变更时标记脏标志，定期保存到FLASH固定分区，避免频繁擦写
- 配置版本管理和兼容性处理，支持旧配置平滑迁移
- 提供默认配置，分区加载失败时触发出厂设置重置
- 敏感配置加密存储
- 管理低电量阈值配置，为状态管理器提供电量判断依据

## 8. 日志管理器

**职责**：统一日志输出，支持三种日志模式切换

**关键行为**：
- 支持三种日志模式切换：
  1. `log`库：通用日志，适配多平台
  2. `defmt`：轻量化日志，适配嵌入式平台
  3. 无log模式：剔除所有日志代码，极致降低功耗
- 日志存储策略：核心日志写入FLASH固定分区（循环覆盖，预留16KB空间）
- 敏感数据脱敏：屏蔽Wi-Fi密码、API密钥等信息
