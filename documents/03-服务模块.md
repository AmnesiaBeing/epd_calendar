# 服务模块划分

> **文档更新时间**：2026-02-18
> **实现状态**：已完成核心框架，各服务模块已实现业务逻辑，硬件抽象层待实现

---

## 1. 状态管理器 (StateManager) ✅

**职责**：维护系统状态机，处理事件分发和状态转换，保障主CPU深度休眠优先级

**实现状态**：已完成

**关键行为**：
- 监听所有系统事件，按优先级分发
- 根据当前状态和事件决定状态转换，优先导向深度睡眠
- 管理深度睡眠的进入和唤醒恢复，任务处理完成后立即触发休眠
- 计算下一次唤醒时间点（为RTC定时器提供调度计划，最大化休眠时长）
- 协调各服务模块的启动和停止，避免冗余运行
- 低电量状态切换与功能裁剪（正常/低电量）
- 集成看门狗管理（喂狗策略）

---

## 2. 时间服务 (TimeService) ✅

**职责**：时间管理、日历计算、事件调度，为系统提供唤醒计划

**实现状态**：已完成

**关键行为**：
- 维护准确时间（RTC寄存器+软件校准偏移）
- 计算农历、节气、节假日（基于sxtwl-rs库）
- 处理时区转换，支持配置更新后的时区重校准
- 应对时间跳变（网络同步/手动修改），重新计算关联事件

**依赖库**：sxtwl-rs（农历计算）

---

## 3. 网络服务 (NetworkService) ✅

**职责**：统一管理所有网络通信，按需连接以降低功耗

**实现状态**：框架已完成，和风天气API预留接口

**关键行为**：
- Wi-Fi连接管理（按需连接，完成同步后立即断开，低电量延长连接间隔）
- SNTP时间同步（预留接口）
- 和风天气API调用（预留接口，暂使用默认数据）
- API调用限制管理（月≤20,000次）
- 网络错误重试（首次失败后2分30秒重试一次，低电量仅重试1次）
- 不承担OTA功能，OTA由蓝牙服务统一处理

---

## 4. 显示服务 (DisplayService) ✅

**职责**：墨水屏驱动和UI渲染，优化刷新流程以减少主CPU占用时间

**实现状态**：已完成框架，硬件驱动待实现

**关键行为**：
- ESP32-C6平台通过SPI接口驱动墨水屏（预留接口）
- 墨水屏非阻塞刷新状态机，避免主CPU空闲等待
- 整合时间、天气、传感器数据等信息显示
- 多状态界面显示（正常界面、二维码界面、错误提示、低电量提示）
- 处理长达10秒的刷新等待时间，期间主CPU进入轻睡眠
- 低电量模式下，将刷新频率优化为必要时刷新

**依赖库**：lxx-calendar-graphics（显示渲染）

---

## 5. 蓝牙服务 (BLEService) ✅

**职责**：BLE配网、配置管理、蓝牙OTA升级

**实现状态**：框架已完成，硬件驱动待实现

**关键行为**：
- BLE广播和设备发现，正常电量下按需开启，低电量下禁用（预留接口）
- 与手机App的加密通信协议（预留接口）
- 配置接收和验证（Wi-Fi、闹钟、时区等）
- 配置保存到FLASH固定分区，标记脏数据并定期持久化
- 蓝牙OTA升级（预留接口）

---

## 6. 音频服务 (AudioService) ✅

**职责**：蜂鸣器控制，低电量下禁用非必要音频输出

**实现状态**：已完成框架，PWM驱动待实现

**关键行为**：
- ESP32-C6平台上使用LEDC外设产生PWM驱动蜂鸣器（预留接口）
- 整点报时（4短1长，正常电量启用，低电量禁用）
- 闹钟音乐播放（预设铃声：小星星、兰花草）
- 声音优先级管理（闹钟优先于整点报时）
- 音频输出完成后立即关闭PWM外设，释放资源

---

## 7. 配置管理器 (ConfigManager) ✅

**职责**：配置持久化存储，管理FLASH固定分区

**实现状态**：框架已完成，FLASH操作待实现

**关键行为**：
- 从FLASH固定分区加载配置到内存（预留接口）
- 配置变更时标记脏标志，定期保存到FLASH固定分区，避免频繁擦写
- 配置版本管理和兼容性处理，支持旧配置平滑迁移
- 提供默认配置，分区加载失败时触发出厂设置重置
- 敏感配置加密存储（预留接口）
- 管理低电量阈值配置，为状态管理器提供电量判断依据

---

## 8. 看门狗管理器 (WatchdogManager) ✅

**职责**：系统监控，防止死锁

**实现状态**：已完成

**关键行为**：
- 30秒超时配置
- 任务执行前/后喂狗
- 低电量自动禁用
- 复位后记录状态

---

## 9. 格言服务 (Quotes) ✅

**职责**：每日格言显示

**实现状态**：已完成

**关键行为**：
- 从一言数据库预编译格言数据
- 支持随机获取和按日期获取
- 返回格式：格言 + 来源 + 作者

---

## 待实现（硬件抽象层）

以下功能需要根据目标平台实现硬件抽象：

1. **DisplayService**: SPI接口驱动墨水屏
2. **NetworkService**: Wi-Fi驱动、SNTP客户端
3. **BLEService**: BLE外设初始化和通信
4. **AudioService**: LEDC PWM输出
5. **PowerManager**: ADC电池电压读取
6. **ConfigManager**: FLASH分区读写

---

## 日志管理器

**状态**：未实现（后续拓展）

日志功能暂时依赖 `lxx-calendar-common` 中的条件编译实现。
