# lxx-calendar 智能墨水屏时钟软件架构设计文档
## 一、系统架构概览
本系统采用**事件驱动、双核/双单元协同**的软件架构，基于ESP32-C6的硬件特性设计，同时预留多平台适配能力。主CPU负责复杂任务，**低功耗控制单元（LPU）** 负责低功耗监控（ESP32-C6上具体实现为LP Core低功耗核心，其他芯片/模拟器上为专用低功耗核心/低功耗线程），两者通过标准化共享内存（ESP32-C6上为RTC内存，其他平台为普通内存）通信。

系统核心目标是**主CPU大部分时间处于深度睡眠状态**，仅按需被LPU唤醒处理必要任务，实现超长续航。项目采用`cargo workspace`组织工程结构，核心依赖`embassy-rs`生态实现嵌入式异步驱动与低功耗管理。

## 二、系统状态与事件
### 系统状态（3个核心状态）
1. **深度睡眠状态**
   - 主CPU完全关闭，外设全部断电
   - LPU维持计时和关键监控（按键、定时）
   - 可由LPU定时器或按键唤醒

2. **蓝牙连接状态**
   - BLE开启，等待手机连接
   - LED指示：未配网时快闪（2Hz），已配网慢闪（0.5Hz）
   - 屏幕显示：未配网显示二维码，已配网显示正常界面+设置提示
   - 超时机制：5分钟无操作自动退出

3. **正常工作状态**
   - 按LPU调度计划唤醒执行任务
   - 处理闹钟、整点报时等事件
   - 网络同步（每2小时，低电量时延长至4小时）

### 状态转换规则
- **上电/复位** → 检查固定分区配置状态 → 未配网：蓝牙连接状态；已配网：正常工作状态
- **正常工作状态** + 短按按键 → 蓝牙连接状态
- **正常工作状态** + 长按15秒 → 恢复默认设置（清除配置信息） → 蓝牙连接状态（未配网）
- **正常工作状态** + 到达休眠时间/任务处理完成 → 深度睡眠状态
- **蓝牙连接状态** + 超时（5分钟） → 已配网：正常工作状态；未配网：深度睡眠状态
- **深度睡眠状态** + LPU定时器唤醒 → 正常工作状态/蓝牙连接状态
- **深度睡眠状态** + 按键唤醒 → 忽略休眠设置 → 正常工作状态/蓝牙连接状态

### 核心事件列表
1. **唤醒事件**
   - WAKE_FROM_DEEP_SLEEP：从深度睡眠唤醒
   - WAKE_BY_LPU：LPU定时器唤醒
   - WAKE_BY_BUTTON：按键唤醒
   - WAKE_BY_WDT：看门狗唤醒

2. **用户输入事件**
   - BUTTON_SHORT_PRESS：按键短按
   - BUTTON_LONG_PRESS：按键长按15秒
   - BLE_CONFIG_RECEIVED：收到蓝牙配置

3. **时间事件**
   - MINUTE_TICK：每分钟触发（显示刷新）
   - HOUR_CHIME_TRIGGER：整点报时触发（XX:59:56-XX:00:00）
   - ALARM_TRIGGER：闹钟触发

4. **网络事件**
   - NETWORK_SYNC_REQUESTED：请求网络同步
   - NETWORK_SYNC_COMPLETE：网络同步完成（含时间和天气）
   - NETWORK_SYNC_FAILED：网络同步失败

5. **系统事件**
   - ENTER_DEEP_SLEEP：即将进入深度睡眠（实际上主处理器此时还活着，处理完最后的事件后才会进入深度睡眠）
   - ENTER_BLE_MODE：进入蓝牙模式
   - ENTER_NORMAL_MODE：进入正常工作模式
   - CONFIG_CHANGED：配置变更
   - LOW_POWER_DETECTED：检测到低电量
   - OTA_TRIGGERED：收到OTA升级指令
   - OTA_UPDATE_COMPLETE：OTA升级完成

## 三、看门狗策略
### 1. 看门狗配置
- **ESP32-C6平台**：使用RTC看门狗，超时时间为30秒，由主CPU的状态管理服务喂狗
- **多平台适配**：无硬件看门狗的平台，采用软件看门狗实现核心监控逻辑，譬如线程模拟

### 2. 喂狗策略
- LPU：每次唤醒主CPU执行任务后喂狗
- 看门狗复位后，通过固定分区记录复位状态，重启后优先恢复核心功能

## 四、服务模块划分
### 1. 状态管理器
- **职责**：维护系统状态机，处理事件分发和状态转换，保障主CPU深度休眠优先级
- **关键行为**：
  - 监听所有系统事件，按优先级分发
  - 根据当前状态和事件决定状态转换，优先导向深度睡眠
  - 管理深度睡眠的进入和唤醒恢复，任务处理完成后立即触发休眠
  - 计算下一次唤醒时间点（为LPU提供调度计划，最大化休眠时长）
  - 协调各服务模块的启动和停止，避免冗余运行
  - 低电量状态切换与功能裁剪（正常/低电量）

### 2. 时间服务
- **职责**：时间管理、日历计算、事件调度，为LPU提供唤醒计划
- **关键行为**：
  - 维护准确时间（RTC寄存器+软件校准偏移）
  - 计算农历、节气、节假日（每日计算一次并缓存至固定分区）
  - 处理时区转换，支持配置更新后的时区重校准
  - 应对时间跳变（网络同步/手动修改），重新计算关联事件并同步至LPU

### 3. 网络服务
- **职责**：统一管理所有网络通信，按需连接以降低功耗
- **关键行为**：
  - Wi-Fi连接管理（按需连接，完成同步后立即断开，低电量延长连接间隔）
  - SNTP时间同步（获取网络时间，校准本地RTC）
  - 和风天气API调用（获取3天天气，缓存至固定分区）
  - API调用限制管理（月≤20,000次）
  - 网络错误重试（首次失败后2分30秒重试一次，低电量仅重试1次）
  - 不承担OTA功能，OTA由蓝牙服务统一处理

### 4. 显示服务
- **职责**：墨水屏驱动和UI渲染，优化刷新流程以减少主CPU占用时间
- **关键行为**：
  - ESP32-C6、泰山派平台通过SPI接口驱动墨水屏，模拟器平台通过SDL库模拟显示
  - 墨水屏非阻塞刷新状态机，避免主CPU空闲等待
  - 整合时间、天气、传感器数据等信息显示
  - 多状态界面显示（正常界面、二维码界面、错误提示、低电量提示）
  - 处理长达10秒的刷新等待时间，期间主CPU进入轻睡眠
  - 预留显示主题支持（目前仅一种）
  - 低电量模式下，将刷新频率优化为必要时刷新（避免每分钟刷新）

### 5. 蓝牙服务
- **职责**：BLE配网、配置管理、蓝牙OTA升级
- **关键行为**：
  - BLE广播和设备发现，正常电量下按需开启，低电量下禁用
  - 与手机App的加密通信协议（ESP32-C6启用RSA硬件加密解密，其他平台视情况适配，模拟器平台不需适配（加密解密返回原始数据））
  - 配置接收和验证（Wi-Fi、闹钟、时区等）
  - 配置保存到FLASH固定分区，标记脏数据并定期持久化
  - 蓝牙OTA升级（接收固件、校验完整性、写入备用分区、触发重启切换）

### 6. 音频服务
- **职责**：蜂鸣器控制，低电量下禁用非必要音频输出
- **关键行为**：
  - 在ESP32-C6平台上，使用LEDC外设产生PWM驱动蜂鸣器，其他平台可使用日志模拟，模拟器平台可通过声卡播放
  - 整点报时（4短1长，正常电量启用，低电量禁用）
  - 闹钟音乐播放（预设铃声：小星星、兰花草）
  - 声音优先级管理（闹钟优先于整点报时）
  - 音频输出完成后立即关闭PWM外设，释放资源

### 7. 低功耗控制单元（LPU）
- **职责**：低功耗监控和精确计时，主导主CPU唤醒调度，保障主CPU深度休眠
- **抽象实现（多平台适配）**：
  - ESP32-C6：具体实现为LP Core低功耗核心，占用RTC内存，功耗最优
  - 带低功耗核心的其他芯片：映射为对应低功耗核心，复用通信逻辑
  - 无低功耗核心的芯片/模拟器：实现为低优先级、低时钟频率线程，关闭抢占式调度
- **关键行为**：
  - 每秒唤醒一次检查时间事件（ESP32-C6 LP Core）/ 定时心跳检测（其他平台）
  - 通过LP I2C（ESP32-C6）或标准化接口读取温湿度传感器（每分钟一次）
  - 按键监控（支持15秒长按检测，无外设操作时不唤醒主CPU）
  - 根据时间服务提供的计划，精准唤醒主CPU处理必要任务
  - 通过RTC共享内存（ESP32-C6）/ 标准化共享内存（其他平台）与主CPU通信，采用原子操作避免锁竞争
  - 喂RTC看门狗（仅ESP32-C6），上报心跳状态（其他平台）
  - 主CPU任务处理完成后，接收休眠指令并进入低功耗监控状态

### 8. 配置管理器
- **职责**：配置持久化存储，管理FLASH固定分区，适配多平台
- **关键行为**：
  - 从FLASH固定分区加载配置到内存（ESP32：FLASH的NVS分区；泰山派、模拟器平台：bin文件指定段/虚拟FLASH）
  - 配置变更时标记脏标志，定期保存到FLASH固定分区，避免频繁擦写
  - 配置版本管理和兼容性处理，支持旧配置平滑迁移
  - 提供默认配置，分区加载失败时触发出厂设置重置
  - 敏感配置加密存储（ESP32-C6：启用RSA硬件加密；其他平台：简化适配，仅标注安全风险）
  - 管理低电量阈值配置，为状态管理器提供电量判断依据

### 9. 日志管理器
- **职责**：统一日志输出，支持三种日志模式切换，兼顾可调试性与功耗
- **关键行为**：
  - 支持三种日志模式，编译时/运行时可切换，低电量模式下默认禁用日志：
    1.  log库：通用日志，适配多平台，支持分级输出（Error/Warn/Info）
    2.  defmt：轻量化日志，适配嵌入式平台，支持分级输出（Error/Warn/Info）
    3.  无log模式：剔除所有日志代码，极致降低功耗，仅保留硬件故障报警
  - 日志存储策略：核心日志写入FLASH固定分区（循环覆盖，预留16KB空间），支持通过蓝牙导出
  - 敏感数据脱敏：屏蔽Wi-Fi密码、API密钥等信息，避免泄露
  - 看门狗复位、OTA失败等关键事件，强制记录至固定分区，不随日志模式关闭而失效

## 五、显示服务详细设计
### 1. 显示特性
- **墨水屏型号**：yrd0750ryf665f60（7.5英寸，800×480，黑白红黄4色，这里仅使用黑白2色）
- **刷新特性**：支持局部写数据，但刷新必须是全局刷新
- **刷新时间**：全局刷新（包括清屏）后，BUSY信号约10秒才结束
- **低功耗优化**：低电量模式下，仅在时间变更、闹钟触发时刷新，关闭每分钟自动刷新

### 2. 工作模式显示内容样式1（800×480像素）
```
┌─────────────────────────────────────────────────────────────────┐
│ 时间区域（顶部20%）                                            │
│ 23:59               周一                                   80%  │
│ 2024-01-15 [元旦]                                           ●   │
│ 甲辰年冬月初四 龙 [宜：出行 忌：嫁娶]                          │
├─────────────────────────────────────────────────────────────────┤
│ 天气区域（中部30%）                                            │
│ 🌤 22°C 65%      🌤 25°/18° 🌧 24°/19° ☀ 23°/17°             │
│ 室内：23°C 55%   今天        明天        后天                    │
├─────────────────────────────────────────────────────────────────┤
│ 格言区域（底部50%）                                            │
│ 格言：知足常乐，终身不辱；知止常止，终身不耻。                  │
│                                                              ▼  │
└─────────────────────────────────────────────────────────────────┘
```
- 暂时仅支持目前1种样式，后续样式应可通过OTA升级实现

### 3. 显示刷新状态机
```rust
enum RefreshState {
    Idle,           // 空闲状态，可接收新刷新请求
    SendingData,    // 工作状态，发送像素数据到屏幕（约500ms）
    Refreshing,     // 已发送刷新命令，等待BUSY信号（最多等待10秒）
    Error,          // 刷新错误（如BUSY超时，初始化失败等）
}
```

### 4. 刷新流程优化
1. **数据准备阶段**：
   - 更新显示缓冲区的局部区域（时间、天气、格言等）
   - 不立即刷新，等待统一调度，避免频繁唤醒主CPU

2. **刷新调度策略**：
   - 正常模式：每分钟在0秒开始刷新，优先级应当比其他事件优先级低
   - 刷新期间不接受新的刷新请求（丢弃或排队，优先保障核心任务）

3. **BUSY等待优化**：
   - 发送刷新命令后进入Refreshing状态
   - 使用异步功能检查BUSY信号，超时10秒后切换到Error状态

## 六、数据流与通信
### 1. 事件驱动架构
- **优先级事件通道**：基于`embassy-rs`异步通道实现，跨服务事件传递，按优先级处理
- **事件生产者**：各服务产生事件并发送到通道，避免直接模块调用
- **事件消费者**：状态管理器接收并分发事件，处理完成后立即触发主CPU休眠

### 2. 共享状态观察
- **Watch模式**：用于频繁更新的只读状态（如当前时间、天气、电量状态），基于`embassy-rs`信号量实现
- **Signal模式**：用于一次性通知（如唤醒信号、OTA触发信号）
- **Mutex保护**：用于需要修改的共享状态（如配置数据），采用`embassy-rs`异步互斥锁，减少阻塞时间

### 3. LPU与主CPU通信机制
- **抽象共享内存**（多平台适配）：
  - ESP32-C6：RTC共享内存（8KB分配），具体划分：
    - LP Core程序代码：4KB
    - LP Core数据/堆栈：1KB
    - 共享数据：2KB（事件标志、传感器数据、唤醒计划）
    - 预留：1KB
  - 其他平台：FLASH固定分区/内存缓冲区，按相同数据格式划分
- **中断唤醒**：ESP32-C6 LP Core通过GPIO中断唤醒主CPU；其他平台通过线程信号量唤醒
- **原子操作**：避免锁竞争，确保数据一致性，主CPU写入共享内存后立即通知LPU，随后进入休眠

## 七、关键时序要求
| 功能 | 触发条件 | 时间要求 | 备注 |
|------|----------|----------|------|
| 整点报时 | XX:59:56-XX:00:00 | 每响间隔400ms | 最后一响500ms，低电量模式禁用 |
| 闹钟响应 | 预设时间到达 | 立即响应 | 播放完整音乐，低电量模式保留 |
| 显示刷新 | 每分钟00秒（正常）/ 关键事件（低电量） | BUSY约10秒 | 含数据处理和屏幕刷新，期间主CPU轻睡眠 |
| 网络同步 | 每2小时+异常重试（正常）/ 每4小时（低电量） | ≤10秒 | 连接+请求+断开，完成后立即休眠主CPU |
| 按键响应 | 检测到按键 | ≤100ms（去抖后） | 支持15秒长按检测，由LPU处理，非必要不唤醒主CPU |
| 配网流程 | 用户操作开始 | ≤1分钟 | 从进入配网到连接成功，低电量模式禁用配网 |
| OTA升级 | 蓝牙接收固件完成 | ≤5分钟 | 校验+写入备用分区，完成后触发重启 |
| 主CPU休眠切换 | 任务处理完成 | ≤500ms | 从任务结束到进入深度睡眠，最大化休眠时长 |

## 八、配置参数
### 1. 时间配置
- 时区偏移（相对于UTC的秒数）
- 闹钟设置（最多3个：时间、重复周期、铃声）
- 整点报时开关
- 自动休眠时段（开始和结束时间，默认关闭）

### 2. 网络配置
- Wi-Fi SSID和密码（敏感数据，ESP32-C6 RSA加密存储）
- 和风天气API密钥（敏感数据，ESP32-C6 RSA加密存储）
- 和风天气位置ID（城市ID、城市名称）

### 3. 显示配置
- 显示主题（预留，目前仅一种）
- 低电量刷新开关（默认开启，仅刷新核心信息）

### 4. 系统配置
- 日志模式选择（log库/defmt/无log）
- OTA自动升级开关
- 低电量阈值（默认30%，可配置）

## 九、功耗管理
### 1. 功耗模式
- **深度睡眠**：主CPU关闭，仅LPU运行，ESP32-C6约10μA，其他平台按LPU实现优化（核心目标，主CPU大部分时间处于此状态）
- **轻度活跃**：主CPU短暂运行（显示刷新10秒，网络同步5-10秒），任务完成后立即切换至深度睡眠
- **高度活跃**：BLE连接状态，约几十mA，正常电量启用，低电量禁用，超时后强制切换至深度睡眠

### 2. 电量状态（两种简化模式）
- **正常电量（≥30%）**：全功能运行，每2小时同步网络，每分钟刷新显示，开启整点报时和蓝牙功能
- **低电量（<30%）**：功能裁剪，最大化主CPU休眠时长：
  - 关闭蓝牙服务（禁止配网和OTA）
  - 关闭整点报时
  - 网络同步间隔延长至4小时，仅重试1次
  - 显示仅刷新核心时间信息，关闭天气和格言区域
  - 禁用日志输出（切换至无log模式）
  - 仅保留闹钟核心功能，触发后正常响应

### 3. 功耗优化核心措施（保障主CPU深度休眠）
1.  **唤醒源收敛**：主CPU仅由LPU定时器、按键触发唤醒，关闭所有冗余唤醒源，避免无意义唤醒
2.  **任务批处理**：将网络同步、显示刷新、传感器数据处理等任务，集中在同一唤醒周期内执行，减少主CPU唤醒次数
3.  **外设按需启停**：主CPU唤醒后仅开启当前任务所需外设（如刷新时开墨水屏，同步时开Wi-Fi），任务结束立即关闭外设，不保留任何外设供电
4.  **休眠时长最大化**：LPU精准计算下次唤醒时间（如距离下一次刷新/同步/闹钟的最长间隔），主CPU处理完任务后直接进入深度睡眠，无任何空闲等待
5.  **冗余功能裁剪**：低电量模式下进一步裁剪非核心功能，减少主CPU活跃时间
6.  **基于`embassy-rs`优化**：利用`embassy-rs`的异步驱动和低功耗调度，减少主CPU空转，提升休眠效率

### 4. 电量校准机制
- 首次上电及每充电一次，进行电池电压校准，修正ADC检测误差，确保电量状态判断准确
- 校准数据存储至FLASH固定分区，断电不丢失

## 十、硬件接口（ESP32-C6，多平台适配预留）
| 引脚 | 功能 | 控制核心 | 备注 |
|------|------|----------|------|
| IO2 | ADC电池电压检测 | 主CPU | 按2档电量显示（正常/低电量） |
| IO22 | 墨水屏SCL | 主CPU | 7.5英寸4色屏（使用黑白），低电量减少操作 |
| IO23 | 墨水屏SDA | 主CPU | 分辨率800×480 |
| IO20 | 墨水屏DC | 主CPU | |
| IO18 | 墨水屏BUSY | 主CPU | 非阻塞刷新状态机，期间主CPU轻睡眠 |
| IO21 | 墨水屏CS | 主CPU | |
| IO19 | 墨水屏RST | 主CPU | |
| IO9 | 按键 | LPU（LP Core） | 外部上拉，按下检测，非必要不唤醒主CPU |
| IO6 | LED指示灯 | 主CPU | 低电平点亮，指示设备状态，低电量减少闪烁 |
| IO7 | 蜂鸣器 | 主CPU | LEDC PWM控制，低电量禁用非闹钟音频 |
| IO10 | SHT20 SCL | LPU（LP Core） | LP I2C低功耗读取，每分钟一次 |
| IO11 | SHT20 SDA | LPU（LP Core） | 温湿度传感器，数据写入共享内存 |
| - | RSA硬件加密 | 主CPU | ESP32-C6自带，敏感数据加密，其他平台简化适配 |

## 十一、错误处理
### 1. 可恢复错误
- 网络暂时不可用：重试2次后（低电量1次）显示离线状态，缓存上次有效数据
- 传感器读取失败：使用上次有效数据，标记陈旧，写入日志
- 显示刷新失败：尝试复位屏幕，最多3次，失败后进入低电量显示模式
- LPU与主CPU通信异常：主CPU主动唤醒LPU并重启通信，多次失败则禁用LPU，主CPU接管计时（牺牲功耗保障基础功能）

### 2. 需用户干预错误
- Wi-Fi凭证无效：进入蓝牙连接状态重新配网，低电量模式下仅提示无法同步
- 时间同步失败：显示时间可能不准，等待下次同步，写入关键日志
- FLASH固定分区损坏：触发出厂设置重置，进入蓝牙配网状态，标记分区故障

### 3. 系统保护
- 看门狗定时器：防止系统死锁，复位后记录状态并优先恢复核心功能
- 内存保护：检测内存溢出和损坏，使用`embassy-rs`内存管理机制，避免内存泄漏
- 电源监控：低电量保护（<10%），关闭所有非必要功能，仅保留按键唤醒提示充电，防止过度放电损坏电池
- OTA升级失败：自动回滚至原固件分区，保留原有配置，避免设备变砖

## 十一、Cargo Workspace 项目组织

## 1. Workspace 整体结构

项目采用`cargo workspace`组织，拆分为多个功能独立的crate，便于维护、复用和多平台适配，核心依赖`embassy-rs`生态。目录结构如下：

```
lxx-calendar/
├── Cargo.toml                  # Workspace 配置文件，声明成员crate和全局依赖
├── .cargo/
│   └── config.toml             # Cargo配置（目标平台、链接参数等）
├── README.md                   # 项目说明文档
├── LICENSE                     # 许可证文件，MIT协议
├── lxx-calendar-core/          # 项目核心主程序
│   ├── Cargo.toml
│   └── src/
│       ├── main.rs             # 主程序入口，根据目标平台选择初始化
│       └── tasks.rs            # 主任务定义和调度
├── lxx-calendar-common/        # 抽象层（通用）
│   ├── Cargo.toml
│   └── src/
│       ├── lib.rs              # 包含默认的无日志的定义
│       ├── traits/             # 硬件Trait定义
│       │   ├── mod.rs
│       │   ├── lpu.rs          # LPU的抽象定义
│       │   ├── epd.rs          # 墨水屏显示驱动接口
│       │   ├── rtc.rs          # RTC时钟接口
│       │   ├── sensor.rs       # 传感器接口
│       │   ├── buzzer.rs       # 蜂鸣器接口
│       │   ├── button.rs       # 按键接口
│       │   ├── led.rs          # LED指示灯接口
│       │   ├── wifi.rs         # Wi-Fi接口
│       │   └── battery.rs      # 电池检测接口
│       ├── types/              # 通用类型
│       │   ├── mod.rs
│       │   ├── shared_mem.rs   # 共享内存定义（注意esp32c6平台需要增加特殊标记，表示该内存需要编译到RTC内存）
│       │   ├── time.rs         # 时间相关类型
│       │   ├── weather.rs      # 天气相关类型
│       │   ├── display.rs      # 显示相关类型
│       │   ├── config.rs       # 配置类型
│       │   └── error.rs        # 错误类型
│       └── events/             # 通用的事件定义
│           ├── mod.rs
│           └── system.rs       # 系统事件定义
├── lxx-calendar-boards/        # 板级实现层
│   ├── esp32c6/                # ESP32-C6平台驱动实现
│   │   ├── lpu-core/            # LP Core独立crate，支持Rust编程
│   │   │   ├── Cargo.toml
│   │   │   └── src/
│   │   │       ├── main.rs
│   │   │       ├── monitor.rs
│   │   │       ├── i2c.rs
│   │   │       ├── button.rs
│   │   │       └── shared_mem.rs
│   │   ├── Cargo.toml
│   │   └── src/
│   │       ├── lib.rs
│   │       ├── board.rs        # 板级外设初始化
│   │       ├── pins.rs         # 引脚定义
│   │       ├── lp_loader.rs    # LP Core加载实现
│   │       └── impls/          # 硬件Trait实现
│   │           ├── mod.rs
│   │           ├── epd.rs      # 显示驱动实现
│   │           ├── rtc.rs      # RTC实现
│   │           ├── sensor.rs   # 传感器实现
│   │           ├── buzzer.rs   # 蜂鸣器实现
│   │           ├── button.rs   # 按键实现
│   │           ├── led.rs      # LED实现
│   │           ├── wifi.rs     # Wi-Fi实现
│   │           ├── ble.rs      # BLE实现
│   │           └── battery.rs  # 电池检测实现
│   ├── tspi/                   # 泰山派平台驱动实现
│   │   ├── Cargo.toml
│   │   └── src/
│   │       ├── lib.rs
│   │       ├── board.rs
│   │       ├── pins.rs
│   │       ├── lpu/            # 模拟LPU
│   │       │   ├── mod.rs
│   │       │   ├── simulated.rs # LPU模拟实现
│   │       │   └── shared_mem.rs
│   │       └── impls/          # 硬件Trait实现
│   │           ├── mod.rs
│   │           ├── epd.rs
│   │           └── ...
│   └── simulator/              # PC模拟器平台驱动实现
│       ├── Cargo.toml
│       └── src/
│           ├── lib.rs
│           ├── board.rs
│           ├── pins.rs
│           ├── lpu/            # 模拟LPU
│           │   ├── mod.rs
│           │   ├── simulated.rs
│           │   └── shared_mem.rs
│           ├── drivers/        # 模拟驱动
│           │   ├── mod.rs
│           │   ├── display.rs  # SDL2窗口模拟
│           │   └── fake_sensor.rs
│           └── impls/          # 硬件Trait实现
│               ├── mod.rs
│               ├── epd.rs
│               └── ...
├── lxx-calendar-drivers/       # 公用的外设驱动层
│   ├── epd/                    # 墨水屏驱动实现
│   │   ├── Cargo.toml
│   │   └── src/
│   │       ├── lib.rs
│   │       ├── interface.rs    # 驱动接口定义
│   │       ├── yrd0750ryf665f60.rs   # YRD0750RYF665F60型号驱动
│   │       └── spi.rs          # SPI通信封装
│   ├── sht20/                  # SHT20温湿度传感器驱动
│   │   ├── Cargo.toml
│   │   └── src/
│   │       ├── lib.rs
│   │       └── sht20.rs        # SHT20驱动实现
│   └── buzzer/                 # 蜂鸣器驱动
│       ├── Cargo.toml
│       └── src/
│           └── buzzer.rs       # 蜂鸣器驱动实现
├── lxx-calendar-graphics/      # 图形资源库
│   ├── assets/                     # 原始资源文件（图标、字体等）
│   │   ├── icons/                  # SVG格式图标
│   │   │   ├── weather/
│   │   │   ├── status/
│   │   │   └── zodiac/
│   │   └── fonts/                  # TTF字体文件
│   ├── resources/                  # 配置文件
│   │   ├── display_layout.yaml     # 显示布局定义
│   │   └── weather_codes.json      # 天气代码映射
│   ├── Cargo.toml
│   ├── build.rs                # 构建脚本（资源处理）
│   └── src/
│       ├── lib.rs
│       ├── builder/            # 资源构建工具
│       │   ├── mod.rs
│       │   ├── font.rs         # 字体处理
│       │   ├── icon.rs         # 图标处理
│       │   └── layout.rs       # 布局处理
│       ├── layout/             # 显示布局定义
│       │   ├── mod.rs
│       │   ├── default.rs      # 默认布局
│       │   └── region.rs       # 区域定义
│       └── render/             # 渲染函数
│           ├── mod.rs
│           ├── text.rs         # 文本渲染
│           ├── icon.rs         # 图标渲染
│           └── canvas.rs       # 画布抽象
├── lxx-calendar-quotes/        # 格言库，编译期处理格言，src提供对外获取格言的接口
│   ├── Cargo.toml
│   ├── build.rs              # 构建脚本（编译期处理格言）
│   └── src/
│       ├── lib.rs              # 对外接口，提供获取格言的API
│       ├── parser.rs           # 格言解析器（编译期使用）
│       ├── storage.rs          # 格言存储（编译期生成）
│       └── data.rs             # 格言数据（编译期生成）
├── lxx-calendar-services/      # 服务层（业务逻辑）
│   ├── Cargo.toml
│   └── src/
│       ├── lib.rs
│       ├── state_manager/      # 状态管理器
│       │   ├── mod.rs
│       │   └── manager.rs
│       ├── time_service/       # 时间服务
│       │   ├── mod.rs
│       │   ├── service.rs
│       │   ├── calendar.rs     # 农历计算
│       │   └── scheduler.rs    # 事件调度
│       ├── network_service/    # 网络服务
│       │   ├── mod.rs
│       │   ├── service.rs
│       │   ├── ntp_client.rs   # NTP客户端
│       │   └── weather_client.rs # 天气客户端
│       ├── display_service/    # 显示服务
│       │   ├── mod.rs
│       │   ├── service.rs
│       │   ├── renderer.rs     # 渲染引擎
│       │   └── manager.rs      # 显示管理
│       ├── ble_service/        # 蓝牙服务
│       │   ├── mod.rs
│       │   └── service.rs
│       ├── audio_service/      # 音频服务
│       │   ├── mod.rs
│       │   └── service.rs
│       ├── config_manager/     # 配置管理器
│       │   ├── mod.rs
│       │   └── manager.rs
│       └── power_manager/      # 电源管理器
│           ├── mod.rs
│           └── manager.rs
└── libs/
    ├── embassy/                # embassy-rs异步库（git子模块）
    ├── embassy-executor/
    ├── embassy-sync/
    ├── embassy-time/
    └── embassy-futures/
    ├── esp-hal/                # ESP32-C6硬件抽象层（git子模块）
    ├── esp-lp-hal/             # ESP32-C6 LP Core低功耗核心驱动（git子模块）
    ├── esp-radio/               # ESP32-C6 Wi-Fi/BLE驱动（git子模块）
    ├── sxtwl-rs/               # 农历计算库（git子模块）
    └── sentences-bundle/        # 一言网格言库（git子模块）
```

## 2. 各Crate详细说明

### lxx-calendar-core
- **职责**：项目主程序入口，负责初始化硬件、启动服务、调度任务，包含所有业务逻辑
- **特性**：根据目标平台选择不同的实现，提供统一的main函数
- **依赖**：
  - `lxx-calendar-boards/*`（平台特定）
  - `lxx-calendar-common`（抽象层）
  - `lxx-calendar-graphics`（图形资源）
  - `lxx-calendar-quotes`（格言库）
  - `lxx-calendar-drivers/*`（外设驱动）
  - `embassy-executor`（异步运行时）

### lxx-calendar-common
- **职责**：定义硬件抽象接口（Traits）、通用数据类型和事件系统
- **特性**：`no_std`兼容，无平台依赖，纯抽象定义
- **关键组件**：
  - `traits/`：所有硬件操作的Trait定义
  - `types/`：跨平台使用的数据类型
  - `events/`：系统事件定义（状态变更、时间事件等）

### lxx-calendar-boards
- **职责**：为不同硬件平台提供Trait的具体实现
- **子Crate**：
  - `esp32c6/`：ESP32-C6完整实现，包含LP Core低功耗核心
  - `esp32c6/lp-core/`：LP Core独立crate，支持Rust编程
  - `tspi/`：泰山派实现，使用Linux系统调用模拟硬件
  - `simulator/`：PC模拟器实现，使用SDL2等库模拟显示
- **实现模式**：每个平台提供`impls/`目录，实现所有Common中定义的Traits

### lxx-calendar-drivers
- **职责**：提供具体外设的驱动程序，平台无关
- **子Crate**：
  - `epd/`：墨水屏驱动，支持SPI通信和特定型号
  - `sht20/`：SHT20温湿度传感器驱动，使用I2C协议
  - `buzzer/`：蜂鸣器驱动，使用LEDC PWM控制
- **设计原则**：驱动不直接依赖硬件，通过接口与平台交互

### lxx-calendar-graphics
- **职责**：编译期处理字体和图标资源，生成嵌入式位图数据
- **构建时行为**：`build.rs`处理SVG和TTF文件，生成Rust代码
- **运行时行为**：提供渲染函数和布局管理
- **资源管理**：所有资源编译期嵌入固件，无运行时文件系统依赖

## 3. 构建系统设计

### Workspace根Cargo.toml
```toml
[workspace]
members = [
    "lxx-calendar-core",
    "lxx-calendar-common",
    "lxx-calendar-boards/esp32c6",
    "lxx-calendar-boards/esp32c6/lp-core",
    "lxx-calendar-boards/tspi",
    "lxx-calendar-boards/simulator",
    "lxx-calendar-drivers/epd",
    "lxx-calendar-drivers/sht20",
    "lxx-calendar-drivers/buzzer",
    "lxx-calendar-graphics",
    "lxx-calendar-services",
]
resolver = "2"

[workspace.dependencies]
embassy-executor = "0.9.1"
embassy-sync = "0.7.2"
embassy-time = "0.5.0"
embassy-futures = "0.1.0"
embassy-net = { version = "0.8.0", features = ["tcp", "udp", "dhcpv4", "medium-ethernet"], optional = true }
embassy-net-tuntap = { version = "0.8.0", optional = true }
heapless = "0.9.2"
serde = { version = "1.0.228", default-features = false, features = ["derive"] }
serde-json-core = "0.6.0"
cfg-if = "1.0.0"
nb = "1.1.0"
critical-section = "1.2.0"
paste = "1.0.0"
embedded-hal = "1.0.0"
embedded-hal-async = "1.0.0"
embedded-io = "0.7.1"
embedded-io-async = "0.7.0"
embedded-graphics = "0.8.1"
log = "0.4.29"
defmt = "1.0.1"
defmt-rtt = "0.4.0"
rtt-target = "0.6.2"
panic-rtt-target = "0.1.3"
env_logger = "0.11.8"
esp-hal = { version = "1.0.0", features = ["esp32c6", "unstable"] }
esp-lp-hal = { version = "0.3.0", features = ["esp32c6"] }
esp-radio = { version = "0.17.0", features = ["wifi", "ble"] }
esp-backtrace = "0.14.0"
sht25 = "0.2.0"
rsa = "0.9.0"
sha2 = "0.10.0"
jiff = { version = "0.2.18", default-features = false, features = ["alloc"] }
```

### Workspace 配置要点
- 全局依赖版本统一：在`workspace Cargo.toml`中声明`embassy-rs`、`log`、`defmt`等核心三方crate的版本，避免版本冲突
- 特性开关配置：支持通过`features`切换日志模式、平台适配、LPU实现，例如：
  - `features = ["esp32c6", "lp-core", "defmt", "rsa"]`（ESP32-C6平台，LP Core实现，defmt日志，RSA加密）
  - `features = ["simulator", "LPU-thread", "log", "no-encryption"]`（模拟器平台，线程实现LPU，log库日志，无加密）
- 无堆内存配置：全局启用`heapless`，避免动态内存分配，提升嵌入式系统稳定性
- 编译配置：为ESP32-C6平台配置合适的优化级别（`Optimize = "s"`），平衡性能与固件大小

## 十三、三方 Crate 集成与管理

### 1. 核心三方 Crate 列表（纳入 Workspace 全局依赖）
| Crate 名称 | 所属生态 | 核心用途 | 平台适配 |
|------------|----------|----------|----------|
| `embassy-executor` | embassy-rs | 异步执行器 | 所有平台 |
| `embassy-sync` | embassy-rs | 同步原语、通道、信号量 | 所有平台 |
| `embassy-time` | embassy-rs | 时间管理 | 所有平台 |
| `embassy-futures` | embassy-rs | 异步工具 | 所有平台 |
| `embassy-net` | embassy-rs | 网络栈 | ESP32-C6/模拟器 |
| `embassy-net-tuntap` | embassy-rs | TUN/TAP网络接口 | 模拟器 |
| `esp-hal` | esp-rs | ESP32-C6硬件底层驱动、RTC/LP Core操作 | ESP32-C6 |
| `esp-lp-hal` | esp-rs | ESP32-C6 LP Core低功耗核心驱动 | ESP32-C6 |
| `esp-radio` | esp-rs | ESP32-C6 Wi-Fi/BLE驱动 | ESP32-C6 |
| `log` | rust-lang | 通用日志系统，分级输出 | 所有平台 |
| `defmt` | knurling-rs | 轻量化嵌入式日志，低开销 | ESP32-C6/部分平台 |
| `defmt-rtt` | knurling-rs | defmt日志RTT输出，用于调试 | ESP32-C6 |
| `heapless` | rust-embedded | 无堆内存数据结构（Vec、String等） | 所有平台 |
| `embedded-hal` | rust-embedded | 硬件抽象层（HAL） | 所有平台 |
| `embedded-hal-async` | rust-embedded | 异步HAL | 所有平台 |
| `embedded-io` | rust-embedded | IO抽象 | 所有平台 |
| `embedded-io-async` | rust-embedded | 异步IO | 所有平台 |
| `embedded-graphics` | rust-embedded | 图形库 | 所有平台 |
| `serde` | serde-rs | 配置数据序列化/反序列化，用于持久化 | 所有平台 |
| `serde-json-core` | serde-rs | JSON序列化（no_std） | 所有平台 |
| `nb` | rust-embedded | 非阻塞操作抽象，适配外设驱动 | 所有平台 |
| `critical-section` | rust-embedded | 临界区保护 | 所有平台 |
| `cfg-if` | rust-lang | 条件编译宏 | 所有平台 |
| `paste` | rust-lang | 宏拼接 | 所有平台 |
| `esp-backtrace` | esp-rs | 异常回溯 | ESP32-C6 |
| `sht25` | rust-embedded | SHT25温湿度传感器驱动 | 所有平台 |
| `rsa` | rustcrypto | RSA加密 | 模拟器/泰山派 |
| `sha2` | rustcrypto | SHA2哈希 | 模拟器/泰山派 |
| `jiff` | rust-lang | 时间处理库（no_std支持） | 所有平台 |
| `env_logger` | rust-lang | 日志实现 | 泰山派/模拟器 |

### 2. 集成原则
- **跨平台优先**：优先选择支持多平台的crate，减少平台专属依赖，降低迁移成本
- **轻量化**：嵌入式平台优先选择低开销、小固件体积的crate，避免资源占用过高
- **生态兼容**：优先选择与`embassy-rs`、`esp-rs`生态兼容的crate，减少集成冲突
- **可配置性**：通过`features`开关控制crate功能，支持按需启用（如日志、加密、OTA）
- **版本稳定**：选择正式发布版本，避免使用开发版，保障项目稳定性

### 3. 多平台适配策略
- **条件编译**：使用`#[cfg(target_arch = "riscv32")]`（ESP32-C6）、`#[cfg(feature = "simulator")]`等条件编译指令，区分不同平台的代码实现
- **抽象接口**：通过trait定义抽象接口，不同平台实现对应的trait，核心业务逻辑无感知
- **依赖替换**：模拟器平台替换掉硬件相关crate（如`esp-hal`替换为虚拟外设crate），保留核心逻辑一致
- **特性裁剪**：模拟器平台裁剪掉功耗优化、硬件加密等无关特性，专注于业务逻辑调试

## 十四、OTA 升级设计（蓝牙优先）

### 1. 升级架构（多平台适配）
- **分区规划**（FLASH固定分区，避免SPIFFS）：
  - ESP32-C6：划分`bootloader`→`firmware_a`→`firmware_b`→`ota_temp`→`config`→`log`，支持双分区备份
  - 其他平台：按相同逻辑划分FLASH固定偏移分区，模拟器使用本地文件模拟
- **升级流程**（蓝牙触发，低功耗优先）：
  1.  手机App通过BLE发送OTA升级指令，设备进入蓝牙OTA状态（仅正常电量支持）
  2.  蓝牙服务接收固件数据，写入`ota_temp`分区，实时校验数据完整性
  3.  固件接收完成后，校验固件签名（ESP32-C6启用RSA硬件校验，其他平台简化校验）
  4.  将固件从`ota_temp`写入备用分区（`firmware_b`，首次升级）或非活跃分区
  5.  校验备用分区固件完整性，标记分区可用
  6.  触发设备重启，bootloader加载新固件分区
  7.  新固件启动成功后，标记为活跃分区；启动失败则自动回滚至原固件分区
- **安全控制**：
  - 固件签名校验，禁止非法固件升级
  - 升级中断处理：重启后从断点继续接收，避免重复下载
  - 低电量禁止升级：电量<30%时，拒绝OTA升级指令，防止升级过程中断电

### 2. 模拟器适配
- 无需模拟完整固件传输（复杂度高，无硬件意义）
- 仅验证OTA触发流程+分区切换逻辑：
  1.  模拟蓝牙OTA指令触发
  2.  模拟固件写入虚拟`ota_temp`分区
  3.  模拟固件校验与分区切换
  4.  模拟重启与固件回滚逻辑
- 核心目标：验证架构兼容性，确保升级流程无逻辑漏洞，不追求硬件级精准度

## 十五、模拟器关键功能模拟

### 1. 深度休眠模拟
- **核心逻辑**：`暂停主线程+时间跳跃`，模拟休眠期间的资源关闭与唤醒触发，不追求真实功耗，仅验证调度逻辑
- **实现步骤**：
  1.  主CPU收到`ENTER_DEEP_SLEEP`事件后，暂停所有业务线程，标记"休眠状态"，屏蔽所有外设操作和事件响应
  2.  记录休眠开始时间（虚拟系统时间），LPU模拟线程继续运行（监控定时、按键）
  3.  唤醒触发（定时器/按键）：计算休眠时长，将虚拟系统时间跳跃至唤醒时间点
  4.  恢复所有业务线程，标记"唤醒状态"，执行唤醒后逻辑（如时间同步、显示刷新）
  5.  统计休眠时长，输出理论功耗估算（仅用于调试参考）

### 2. 其他关键功能模拟
- **FLASH固定分区模拟**：使用本地文件或内存缓冲区模拟FLASH分区，按偏移量读写，实现配置、日志、OTA分区的持久化
- **RSA加密模拟**：跳过硬件加密，直接对敏感数据进行明文存储，标注"非安全环境，仅用于调试"
- **日志模拟**：支持三种日志模式切换，`log`/`defmt`日志输出至控制台，无log模式剔除所有日志打印
- **电量模拟**：通过配置文件设置虚拟电量状态，支持手动切换正常/低电量模式，验证功能裁剪逻辑

## 十六、项目核心目标保障（主CPU深度休眠）

本项目的核心目标是**主CPU大部分时间处于深度睡眠状态**，所有架构设计和实现均围绕此目标展开，关键保障措施总结如下：

1.  **LPU主导调度**：将所有低功耗监控、计时、唤醒逻辑下放至LPU，主CPU仅处理复杂业务，不参与持续监控
2.  **任务批处理与按需唤醒**：集中所有需要主CPU处理的任务，在同一唤醒周期内执行，减少唤醒次数
3.  **外设按需启停**：主CPU唤醒后仅开启必要外设，任务完成后立即关闭，不保留任何冗余资源占用
4.  **无空闲等待**：主CPU任务处理完成后，无任何空闲逻辑，直接进入深度睡眠，最大化休眠时长
5.  **功能分级裁剪**：低电量模式下进一步裁剪非核心功能，减少主CPU活跃时间
6.  **基于`embassy-rs`优化**：利用异步驱动和低功耗调度，减少主CPU空转，提升休眠效率
7.  **架构层面约束**：通过事件驱动、模块解耦，避免主CPU被冗余事件唤醒，保障休眠优先级
