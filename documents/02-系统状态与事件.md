# 系统状态与事件

## 系统状态（3个核心状态）

### 1. 深度睡眠状态

- 主CPU完全关闭，外设全部断电
- RTC维持计时和关键监控（按键、定时）
- 可由RTC定时器或按键唤醒

### 2. 蓝牙连接状态

- BLE开启，等待手机连接
- LED指示：未配网时快闪（2Hz），已配网慢闪（0.5Hz）
- 屏幕显示：未配网显示二维码，已配网显示正常界面+设置提示
- 超时机制：5分钟无操作自动退出

### 3. 正常工作状态

- 按调度计划唤醒执行任务
- 处理闹钟、整点报时等事件
- 网络同步（每2小时，低电量时延长至4小时）

## 状态转换规则

| 当前状态 | 触发条件 | 目标状态 |
|---------|---------|---------|
| - | 上电/复位 → 未配网 | 蓝牙连接状态 |
| - | 上电/复位 → 已配网 | 正常工作状态 |
| 正常工作状态 | 短按按键 | 蓝牙连接状态 |
| 正常工作状态 | 长按15秒 | 蓝牙连接状态（恢复出厂设置） |
| 正常工作状态 | 到达休眠时间 | 深度睡眠状态 |
| 蓝牙连接状态 | 超时5分钟 → 已配网 | 正常工作状态 |
| 蓝牙连接状态 | 超时5分钟 → 未配网 | 深度睡眠状态 |
| 深度睡眠状态 | RTC定时器唤醒 | 正常工作状态/蓝牙连接状态 |
| 深度睡眠状态 | 按键唤醒 | 正常工作状态/蓝牙连接状态 |

## 核心事件列表

### 1. 唤醒事件

- `WAKE_FROM_DEEP_SLEEP`：从深度睡眠唤醒
- `WAKE_BY_TIMER`：定时器唤醒
- `WAKE_BY_BUTTON`：按键唤醒
- `WAKE_BY_WDT`：看门狗唤醒

### 2. 用户输入事件

- `BUTTON_SHORT_PRESS`：按键短按
- `BUTTON_LONG_PRESS`：按键长按15秒
- `BLE_CONFIG_RECEIVED`：收到蓝牙配置

### 3. 时间事件

- `MINUTE_TICK`：每分钟触发（显示刷新）
- `HOUR_CHIME_TRIGGER`：整点报时触发（XX:59:56-XX:00:00）
- `ALARM_TRIGGER`：闹钟触发

### 4. 网络事件

- `NETWORK_SYNC_REQUESTED`：请求网络同步
- `NETWORK_SYNC_COMPLETE`：网络同步完成（含时间和天气）
- `NETWORK_SYNC_FAILED`：网络同步失败

### 5. 系统事件

- `ENTER_DEEP_SLEEP`：即将进入深度睡眠
- `ENTER_BLE_MODE`：进入蓝牙模式
- `ENTER_NORMAL_MODE`：进入正常工作模式
- `CONFIG_CHANGED`：配置变更
- `LOW_POWER_DETECTED`：检测到低电量
- `OTA_TRIGGERED`：收到OTA升级指令
- `OTA_UPDATE_COMPLETE`：OTA升级完成
