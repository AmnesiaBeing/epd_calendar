# EPD日历系统重构架构文档（V4.0 完整交互版）
## 文档信息
| 项目名称 | EPD日历系统 |
|----------|-------------|
| 重构目标 | 硬件级低功耗+ULP协同+动态渲染+网络同步+用户交互配对 |
| 核心特性 | ULP接管低频任务、深度睡眠、按需更新、OTA配置、SNTP校时、天气同步、用户配对、蓝牙交互 |

## 一、架构设计理念（补充交互设计）
1. **硬件-软件协同低功耗**：ULP核心接管温湿度采集、按键检测、分钟触发，主CPU 99%时间处于深度睡眠
2. **数据-渲染解耦**：基于RTC共享内存实现被动数据交互，渲染引擎按需局部更新，精准管控墨水屏高压芯片
3. **网络操作最小化**：SNTP校时与天气同步复用WIFI驱动，错峰触发，完成后立即关闭网络
4. **配置可扩展**：支持OTA动态更新布局、位置配置、同步策略，兼容插件式数据源
5. **分层解耦易维护**：清晰的分层架构，各模块职责单一，便于扩展和重构
6. **用户交互轻量化**：采用**低功耗蓝牙（BLE）** 作为用户交互通道，支持首次配对、远程配置、状态查询，兼顾低功耗与可操作性
7. **唤醒机制多样化**：支持ULP自动唤醒、按键短按唤醒、BLE远程唤醒，满足不同场景下的用户操作需求

## 二、整体架构分层（补充交互层）
```
┌─────────────────────────────────────────────────────────────────┐
│  1. UI渲染层 (Rendering Layer)                                  │
│     动态布局引擎 / 智能渲染引擎 / 功耗感知渲染策略 / 配对二维码渲染 │
├─────────────────────────────────────────────────────────────────┤
│  2. 数据管理层 (Data Layer)                                     │
│     RTC共享内存缓存 / 数据模型定义 / 阈值检测 / 数据源适配器 / 配对信息存储 │
├─────────────────────────────────────────────────────────────────┤
│  3. 业务逻辑层 (Business Layer)                                 │
│     ULP事件处理器 / SNTP同步调度器 / 天气更新调度器 / 位置配置管理器 / 配对管理器 / 设备状态机 │
├─────────────────────────────────────────────────────────────────┤
│  4. 交互网络层 (Interaction & Network Layer)                    │
│     共享WIFI驱动 / SNTP客户端 / 天气API客户端 / 低功耗蓝牙(BLE)驱动 / 配对协议处理 │
├─────────────────────────────────────────────────────────────────┤
│  5. 驱动层 (Driver Layer)                                       │
│     ULP核心驱动 / 外设管控驱动 / 显示驱动(高压管控) / RTC驱动 / 按键驱动 / 复位驱动 │
├─────────────────────────────────────────────────────────────────┤
│  6. 硬件抽象层 (HAL Layer)                                      │
│     RTC内存映射 / 高压芯片控制 / ULP程序加载 / 硬件特性封装 / BLE硬件抽象 │
└─────────────────────────────────────────────────────────────────┘
```

### 各层核心职责（补充交互相关）
| 分层 | 核心职责 | 关键技术点 |
|------|----------|------------|
| UI渲染层 | 动态布局解析、OTA配置适配、**配对二维码生成与渲染** | 动态布局解析 |
| 数据管理层 | 被动数据读取、数据模型管理、阈值检测、缓存控制、**配对信息持久化存储** | RTC共享内存、原子操作标记、数据转换适配、Flash配置存储 |
| 业务逻辑层 | 事件驱动处理、同步策略调度、配置管理、状态机控制、**配对流程管理、设备复位逻辑、唤醒策略控制** | ULP唤醒事件解析、时间触发策略、批量更新调度、状态机切换、复位清除逻辑 |
| 交互网络层 | 网络资源管控、SNTP校时、天气数据同步、WIFI按需启停、**低功耗蓝牙驱动、配对协议解析、远程指令处理** | 共享驱动复用、错峰触发、快速休眠、BLE主从模式切换、GATT服务定义 |
| 驱动层 | 硬件设备驱动、外设按需管控、ULP程序运行、RTC时间校准、**按键驱动（短按/长按识别）、复位驱动** | 外设PowerOn/PowerOff、高压精准管控、ULP任务调度、按键事件识别、复位信号处理 |
| 硬件抽象层 | 硬件资源抽象、内存映射、芯片特性封装、**BLE硬件抽象、按键引脚抽象** | RTC内存地址映射、ULP程序加载接口、高压控制引脚封装、BLE射频配置 |

## 三、新增核心模块设计
### 3.1 配对与交互核心模块
| 模块名称 | 所属分层 | 核心职责 |
|----------|----------|----------|
| 配对管理器 | 业务逻辑层 | 首次配对流程控制、配对状态管理、配对信息验证与存储 |
| BLE驱动模块 | 交互网络层 | 低功耗蓝牙协议栈驱动、GATT服务部署、数据收发、远程唤醒触发 |
| 配对信息存储 | 数据管理层 | 配对密钥、用户信息、设备标识的持久化存储与读取 |
| 二维码渲染模块 | UI渲染层 | 配对二维码（包含设备ID、BLE名称）的生成与屏幕渲染 |
| 按键唤醒模块 | 驱动层 | 按键短按/长按事件识别、短按唤醒主CPU、长按触发复位 |
| 设备状态机 | 业务逻辑层 | 管理设备**未配对/已配对/休眠/交互/同步**五种状态，控制状态切换逻辑 |

### 3.2 推荐交互协议：BLE GATT协议
#### 3.2.1 协议选择理由
1. **低功耗特性**：BLE待机功耗仅为**微安级**，与系统深度睡眠策略完全兼容，不会显著影响续航
2. **双向交互**：支持手机APP主动连接设备，发送配置指令；设备也可主动上报状态
3. **广泛兼容性**：几乎所有智能手机都支持BLE，无需额外硬件
4. **快速连接**：BLE连接建立时间短（<1秒），用户操作体验流畅

#### 3.2.2 GATT服务定义
| 服务UUID | 特征UUID | 特征属性 | 功能描述 |
|----------|----------|----------|----------|
| `0000FF00-0000-1000-8000-00805F9B34FB`（设备配置服务） | `0000FF01-0000-1000-8000-00805F9B34FB` | 可读可写 | 存储WIFI配置信息（SSID/密码） |
|  | `0000FF02-0000-1000-8000-00805F9B34FB` | 可读可写 | 存储位置配置信息（位置ID/名称） |
|  | `0000FF03-0000-1000-8000-00805F9B34FB` | 可读 | 设备状态查询（电池电量/配对状态/同步状态） |
|  | `0000FF04-0000-1000-8000-00805F9B34FB` | 可写 | 远程控制指令（触发同步/切换布局/复位） |
| `0000FF10-0000-1000-8000-00805F9B34FB`（配对服务） | `0000FF11-0000-1000-8000-00805F9B34FB` | 可读 | 设备唯一标识ID |
|  | `0000FF12-0000-1000-8000-00805F9B34FB` | 可写 | 配对密钥写入与验证 |

### 3.3 唤醒机制设计
#### 3.3.1 多场景唤醒策略
| 唤醒方式 | 触发条件 | 唤醒目标 | 应用场景 | 功耗控制 |
|----------|----------|----------|----------|----------|
| ULP自动唤醒 | 分钟到达/传感器阈值/按键长按 | 主CPU | 定时同步、数据采集、设备复位 | 仅在触发时唤醒，完成后立即休眠 |
| 按键短按唤醒 | 短按按键（<2秒） | 主CPU+BLE模块 | 用户手动操作、配置设备 | 唤醒后保持BLE开启5分钟，无操作则自动休眠 |
| BLE远程唤醒 | 手机APP发起BLE连接请求 | 主CPU | 远程配置、状态查询 | 仅在BLE连接建立时唤醒，断开后立即休眠 |

#### 3.3.2 复位机制设计
| 触发条件 | 执行动作 | 适用场景 |
|----------|----------|----------|
| 长按按键15秒 | 1. 清除所有配对信息与用户配置<br>2. 恢复出厂设置<br>3. 重启设备并进入未配对状态 | 设备故障、更换用户、忘记配置 |

## 四、核心业务流程（补充配对与交互流程）
### 4.1 首次配对流程
1. **设备上电初始化**：硬件抽象层与驱动层初始化，设备状态机进入**未配对状态**
2. **配对信息检测**：配对管理器读取Flash，确认无配对信息
3. **BLE模块启动**：交互网络层启动BLE模块，进入广播模式，广播包含设备ID的信号
4. **二维码渲染**：UI渲染层生成包含设备ID和BLE名称的二维码，控制显示驱动开启高压并渲染二维码
5. **手机APP配对**：用户扫码或搜索BLE设备，APP与设备建立连接，通过GATT服务写入WIFI配置和位置信息
6. **配对信息存储**：配对管理器验证配置信息，将配对密钥、WIFI信息、位置信息写入Flash
7. **状态切换**：设备状态机切换为**已配对状态**，关闭二维码显示，BLE模块进入待机模式，主CPU进入深度睡眠

### 4.2 用户交互流程（按键短按唤醒）
1. **用户短按按键**：按键驱动识别短按事件，触发ULP唤醒主CPU
2. **设备状态切换**：状态机从**休眠状态**切换为**交互状态**，启动BLE模块并进入广播模式
3. **手机APP连接**：用户打开APP，与设备建立BLE连接
4. **远程配置/控制**：用户通过APP发送指令（修改位置、触发同步、切换布局），设备接收并执行
5. **自动休眠**：配置完成或5分钟无操作后，状态机切换回**休眠状态**，关闭BLE模块，主CPU进入深度睡眠

### 4.3 远程配置流程（BLE唤醒）
1. **手机APP发起连接**：APP扫描BLE设备并发起连接请求
2. **BLE远程唤醒**：BLE驱动检测到连接请求，触发主CPU从深度睡眠中唤醒
3. **状态切换**：状态机进入**交互状态**，建立BLE通信链路
4. **指令执行**：设备接收APP发送的配置指令，更新对应参数并存储
5. **断开连接与休眠**：配置完成后，APP断开BLE连接，设备关闭BLE模块，立即进入深度睡眠

### 4.4 设备复位流程
1. **用户长按按键15秒**：按键驱动识别长按事件，触发复位信号
2. **复位执行**：复位驱动清除Flash中所有配对信息、用户配置和缓存数据
3. **重启设备**：设备重启并进入**未配对状态**，重新渲染配对二维码，等待再次配对

## 五、项目目录结构设计（补充交互模块）
```
epd-calendar/
└ Cargo.toml                     # 项目依赖配置
└ build.rs                       # 编译脚本
└ src/
│   └ main.rs                    # 系统入口（主循环）
│   └ common/                    # 公共模块
│   │   └ error.rs               # 全局错误类型定义
│   │   └ types.rs               # 公共数据类型（新增配对状态、设备状态枚举）
│   └ hal/                       # 硬件抽象层
│   │   └ mod.rs                 # 模块入口
│   │   └ rtc_mem.rs             # RTC共享内存映射
│   │   └ ulp_loader.rs          # ULP程序加载接口
│   │   └ hv_control.rs          # 高压芯片控制封装
│   │   └ ble_hal.rs             # BLE硬件抽象层（新增）
│   │   └ key_hal.rs             # 按键硬件抽象层（新增）
│   └ driver/                    # 驱动层
│   │   └ mod.rs                 # 模块入口
│   │   └ ulp/                   # ULP核心驱动
│   │   │   └ mod.rs
│   │   │   └ manager.rs         # ULP任务管理
│   │   │   └ wakeup.rs          # 唤醒原因解析
│   │   └ peripheral/            # 外设管控驱动
│   │   │   └ mod.rs
│   │   │   └ manager.rs         # 通用外设管理trait
│   │   │   └ i2c.rs             # I2C外设驱动
│   │   │   └ gpio.rs            # GPIO外设驱动
│   │   └ display/               # 显示驱动
│   │   │   └ mod.rs
│   │   │   └ esp32.rs           # ESP32平台驱动
│   │   │   └ hv_manager.rs      # 高压管控扩展
│   │   │   └ partial_update.rs  # 局部更新实现
│   │   │   └ qrcode_render.rs   # 二维码渲染驱动（新增）
│   │   └ rtc/                   # RTC时间驱动
│   │   │   └ mod.rs
│   │   │   └ driver.rs          # RTC读写/校准
│   │   └ network/               # 网络驱动
│   │   │   └ mod.rs
│   │   │   └ wifi.rs            # WIFI驱动（共享）
│   │   └ ble/                   # BLE驱动模块（新增）
│   │   │   └ mod.rs
│   │   │   └ driver.rs          # BLE协议栈驱动
│   │   │   └ gatt_service.rs    # GATT服务定义与部署
│   │   └ key/                   # 按键驱动模块（新增）
│   │   │   └ mod.rs
│   │   │   └ driver.rs          # 按键事件识别（短按/长按）
│   │   │   └ reset_driver.rs    # 复位驱动（长按15秒触发）
│   └ network/                   # 交互网络层（原网络层升级）
│   │   └ mod.rs                 # 模块入口
│   │   └ sntp/                  # SNTP客户端
│   │   │   └ mod.rs
│   │   │   └ client.rs          # SNTP同步实现
│   │   │   └ config.rs          # SNTP配置
│   │   └ weather/               # 天气API客户端
│   │   │   └ mod.rs
│   │   │   └ client.rs          # 天气请求实现
│   │   │   └ model.rs           # 天气数据模型
│   │   └ pairing/               # 配对协议处理（新增）
│   │       └ mod.rs
│   │       └ protocol.rs        # BLE GATT协议解析
│   │       └ command_handler.rs # 远程指令处理
│   └ config/                    # 配置存储层
│   │   └ mod.rs                 # 模块入口
│   │   └ storage.rs             # 通用配置存储
│   │   └ location.rs            # 位置配置管理
│   │   └ sntp.rs                # SNTP配置管理
│   │   └ pairing.rs             # 配对信息存储（新增）
│   └ data/                      # 数据管理层
│   │   └ mod.rs                 # 模块入口
│   │   └ rtc_cache.rs           # RTC数据缓存
│   │   └ model/                 # 数据模型定义
│   │   │   └ mod.rs
│   │   │   └ time.rs            # 时间数据模型
│   │   │   └ sensor.rs          # 传感器数据模型
│   │   │   └ weather.rs         # 天气数据模型
│   │   │   └ pairing.rs         # 配对信息模型（新增）
│   │   └ threshold.rs           # 数据阈值检测
│   └ business/                  # 业务逻辑层
│   │   └ mod.rs                 # 模块入口
│   │   └ ulp_event.rs           # ULP唤醒事件处理器
│   │   └ time_sync.rs           # SNTP同步调度器
│   │   └ weather_sync.rs        # 天气更新调度器
│   │   └ location_manager.rs    # 位置配置管理器
│   │   └ pairing_manager.rs     # 配对管理器（新增）
│   │   └ device_state_machine.rs # 设备状态机（新增）
│   │   └ wakeup_strategy.rs     # 唤醒策略管理器（新增）
│   └ ui/                        # UI渲染层
│   │   └ mod.rs                 # 模块入口
│   │   └ layout/                # 动态布局引擎
│   │   │   └ mod.rs
│   │   │   └ parser.rs          # 布局配置解析
│   │   │   └ template.rs        # 布局模板定义
│   │   │   └ ota.rs             # OTA配置更新
│   │   └ render/                # 智能渲染引擎
│   │   │   └ mod.rs
│   │   │   └ engine.rs          # 渲染核心逻辑
│   │   │   └ partial.rs         # 局部更新优化
│   │   │   └ power_aware.rs     # 功耗感知策略
│   │   └ component/             # UI组件定义
│   │   │   └ mod.rs
│   │   │   └ text.rs            # 文本组件
│   │   │   └ icon.rs            # 图标组件
│   │   │   └ weather.rs         # 天气组件
│   │   │   └ qrcode.rs          # 二维码组件（新增）
│   └ system/                    # 系统集成层
│       └ mod.rs                 # 模块入口
│       └ core.rs                # 系统核心结构体
│       └ main_loop.rs           # 主循环实现
│       └ pairing_flow.rs        # 首次配对流程控制（新增）
```

## 五、核心特性与低功耗策略对应表（补充交互相关）
| 核心特性 | 低功耗策略 | 功耗优化效果 |
|----------|------------|--------------|
| ULP接管低频任务 | ULP采集温湿度、检测按键、触发分钟事件，主CPU深度睡眠 | 主CPU空闲功耗从20-30μA降至3-5μA |
| 精准高压管控 | 仅在渲染需要高压的组件时开启，完成后立即关闭 | 墨水屏刷新功耗降低70-80% |
| 局部渲染优化 | 仅更新变化的脏区域，避免全屏刷新 | 渲染功耗降低60-70% |
| WIFI驱动共享复用 | SNTP与天气同步复用WIFI，单次唤醒完成两次操作 | 网络唤醒次数减少50% |
| 错峰网络同步 | 凌晨3点低峰期执行同步，避开网络拥堵 | 同步耗时减少30%，功耗降低20% |
| 外设按需启停 | I2C/SPI/WIFI等外设仅在使用时上电，用完即关 | 外设待机功耗降低90%以上 |
| 被动数据交互 | 基于RTC内存原子标记，主CPU被动读取数据，无轮询 | 数据总线功耗降低100% |
| BLE低功耗模式 | BLE仅在交互时开启，连接断开后立即关闭，待机功耗微安级 | 交互功能引入的额外功耗可忽略不计 |
| 多策略唤醒控制 | 仅在触发条件满足时唤醒主CPU，无操作则快速休眠 | 避免主CPU长时间处于唤醒状态 |

## 六、系统部署与重构实施步骤（补充交互模块）
### 6.1 重构实施阶段划分（新增阶段）
| 阶段 | 实施内容 | 验收标准 |
|------|----------|----------|
| 阶段1：硬件抽象层与驱动层 | 完成RTC内存映射、ULP程序加载、外设管控驱动、显示高压管控、**BLE驱动、按键驱动、复位驱动** | ULP程序可正常运行，外设可按需启停，BLE可正常广播，按键事件可识别 |
| 阶段2：数据层与业务逻辑层 | 完成RTC数据缓存、ULP事件处理、同步策略调度、**配对管理器、设备状态机、唤醒策略** | 主CPU可被ULP唤醒并处理事件，设备状态切换正常，配对流程可执行 |
| 阶段3：交互网络层与系统集成 | 完成共享WIFI驱动、SNTP+天气同步、**BLE协议处理、配对流程集成、主循环优化** | 网络同步正常，BLE配对与配置正常，主CPU可快速进入深度睡眠 |
| 阶段4：UI层与OTA配置 | 完成动态布局引擎、局部渲染、OTA配置更新、**二维码渲染、交互界面适配** | 布局可动态切换，二维码显示正常，OTA更新平滑无卡顿 |
| 阶段5：功耗测试与优化 | 调整同步频率、渲染策略、**BLE待机时间、唤醒超时时间**，进行整机功耗测试 | 整机平均功耗≤8μA，满足续航目标，交互功能不影响续航 |

### 6.2 部署注意事项（补充交互相关）
1. ULP程序需使用ESP-IDF工具链编译为二进制，通过`ulp_loader.rs`加载到芯片
2. RTC共享内存地址需与ESP32-C6芯片手册一致，避免内存冲突
3. 高压控制引脚需根据硬件实际接线配置，避免接错烧毁设备
4. 网络同步超时时间需合理设置，避免因网络问题导致主CPU长时间唤醒
5. 布局配置需遵循UI组件定义规范，确保渲染引擎可正确解析
6. **BLE模块天线需合理布局**，确保广播信号强度，保证配对成功率
7. **按键引脚需配置上拉电阻**，避免误触发，长按时间阈值需通过测试调整
8. **配对信息需加密存储**，防止被篡改，保障设备安全性